{% extends 'qa_app/base.html' %}
{% load static %}

{% block title %}{% if object.pk %}Редактировать задачу{% else %}Новая задача{% endif %}{% endblock %}

{% block extra_head %}
<style>
    /* Общие стили для формы */
    .card {
        max-width: 1000px;
        margin: 0 auto;
    }

    .card-header h4 {
        font-size: 1.5rem;
        font-weight: 600;
    }

    /* Стили для секций формы */
    .form-section {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .form-section h5 {
        font-size: 1.2rem;
        font-weight: 600;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid;
        margin-bottom: 1.5rem;
    }

    .form-section h5.text-primary {
        border-bottom-color: #0d6efd;
    }

    .form-section h5.text-success {
        border-bottom-color: #198754;
    }

    /* Стили для полей формы */
    .form-label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #495057;
    }

    .form-label i {
        width: 20px;
    }

    .form-control, .form-select {
        border: 1px solid #ced4da;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        font-size: 1rem;
        transition: all 0.15s ease-in-out;
    }

    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        outline: 0;
    }

    /* Стили для ошибок валидации */
    .text-danger.small {
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    /* Подсказки под полями */
    .form-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    /* Обертка для редактора */
    .editor-wrapper {
        border: 1px solid #ced4da;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    /* Стили для текстового поля */
    .description-textarea {
        min-height: 300px;
        resize: vertical;
        width: 100%;
        padding: 1rem;
        border: none;
        font-family: inherit;
        font-size: 1rem;
        line-height: 1.6;
    }

    .description-textarea:focus {
        outline: none;
        box-shadow: none;
    }

    /* Стили для кнопок */
    .btn-submit {
        padding: 0.625rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 500;
        min-width: 180px;
    }

    /* Стили для тулбара редактора */
    .editor-toolbar {
        background: #f8f9fa;
        border-bottom: 1px solid #ced4da;
        padding: 0.5rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .editor-toolbar button {
        background: white;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .editor-toolbar button:hover {
        background: #e9ecef;
        border-color: #86b7fe;
    }

    .editor-toolbar select {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 0.375rem 0.5rem;
        background: white;
        font-size: 0.875rem;
    }

    /* Адаптивность */
    @media (max-width: 768px) {
        .d-flex.justify-content-start.gap-3 {
            flex-direction: column;
            gap: 1rem !important;
        }

        .btn-submit {
            width: 100%;
        }

        .card-header h4 {
            font-size: 1.25rem;
        }

        .form-section h5 {
            font-size: 1.1rem;
        }

        .editor-toolbar {
            flex-direction: column;
            align-items: stretch;
        }

        .editor-toolbar button,
        .editor-toolbar select {
            width: 100%;
            text-align: left;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-xxl-10 col-xl-10 col-lg-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white py-3">
                    <div class="d-flex align-items-center">
                        {% if object.pk %}
                            <i class="fas fa-edit fa-lg me-3"></i>
                            <h4 class="mb-0">Редактирование задачи</h4>
                        {% else %}
                            <i class="fas fa-plus-circle fa-lg me-3"></i>
                            <h4 class="mb-0">Создание новой задачи</h4>
                        {% endif %}
                    </div>
                </div>

                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}

                        <!-- Основная информация -->
                        <div class="form-section">
                            <h5 class="text-primary">
                                <i class="fas fa-info-circle me-2"></i> Основная информация
                            </h5>

                            <!-- Название задачи -->
                            <div class="mb-4">
                                <label for="id_title" class="form-label">
                                    <i class="fas fa-heading me-1"></i> Название задачи <span class="text-danger">*</span>
                                </label>
                                <input type="text"
                                       name="title"
                                       id="id_title"
                                       class="form-control {% if form.title.errors %}is-invalid{% endif %}"
                                       value="{{ form.title.value|default:'' }}"
                                       placeholder="Введите название задачи"
                                       required>
                                {% if form.title.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.title.errors %}
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Укажите краткое и понятное название задачи
                                </div>
                            </div>

                            <!-- Связанный вопрос -->
                            <div class="mb-4">
                                <label for="id_question" class="form-label">
                                    <i class="fas fa-question-circle me-1"></i> Связанный вопрос
                                </label>
                                <select name="question"
                                        id="id_question"
                                        class="form-select {% if form.question.errors %}is-invalid{% endif %}">
                                    <option value="">-- Выберите вопрос --</option>
                                    {% for choice in form.question.field.queryset %}
                                        <option value="{{ choice.pk }}"
                                                {% if form.question.value|stringformat:"s" == choice.pk|stringformat:"s" %}selected{% endif %}>
                                            {{ choice.title }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if form.question.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.question.errors %}
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Можно привязать к существующему вопросу (необязательно)
                                </div>
                            </div>
                        </div>

                        <!-- Описание / Инструкция -->
                        <div class="form-section">
                            <h5 class="text-success">
                                <i class="fas fa-align-left me-2"></i> Описание / Инструкция <span class="text-danger">*</span>
                            </h5>

                            <div class="mb-4">
                                <label for="description" class="form-label">
                                    <i class="fas fa-file-alt me-1"></i> Подробное описание
                                </label>

                                <!-- Простой HTML редактор -->
                                <div class="editor-wrapper">
                                    <!-- Тулбар редактора -->
                                    <div class="editor-toolbar">
                                        <button type="button" onclick="formatText('bold')" title="Жирный">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button type="button" onclick="formatText('italic')" title="Курсив">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button type="button" onclick="formatText('underline')" title="Подчеркнутый">
                                            <i class="fas fa-underline"></i>
                                        </button>
                                        <button type="button" onclick="insertList('ul')" title="Маркированный список">
                                            <i class="fas fa-list-ul"></i>
                                        </button>
                                        <button type="button" onclick="insertList('ol')" title="Нумерованный список">
                                            <i class="fas fa-list-ol"></i>
                                        </button>
                                        <button type="button" onclick="formatText('link')" title="Вставить ссылку">
                                            <i class="fas fa-link"></i>
                                        </button>
                                        <button type="button" onclick="insertHeading()" title="Заголовок">
                                            <i class="fas fa-heading"></i>
                                        </button>
                                        <select onchange="formatText(this.value)">
                                            <option value="">Размер шрифта</option>
                                            <option value="fontSize:small">Маленький</option>
                                            <option value="fontSize:medium">Средний</option>
                                            <option value="fontSize:large">Большой</option>
                                        </select>
                                    </div>

                                    <!-- Текстовое поле -->
                                    <textarea name="description"
                                              id="description"
                                              class="form-control description-textarea {% if form.description.errors %}is-invalid{% endif %}"
                                              placeholder="Введите подробное описание задачи..."
                                              required>{{ form.description.value|default:''|safe }}</textarea>
                                </div>

                                {% if form.description.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.description.errors %}
                                            <i class="fas fa-exclamation-circle me-1"></i>{{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    Поддерживается базовое форматирование текста. Используйте кнопки выше для форматирования.
                                </div>
                            </div>
                        </div>

                        <!-- Кнопки управления -->
                        <div class="mt-5 pt-3 border-top">
                            <div class="d-flex justify-content-start gap-3">
                                <button type="submit" class="btn btn-primary btn-submit">
                                    {% if object.pk %}
                                        <i class="fas fa-save me-2"></i> Сохранить изменения
                                    {% else %}
                                        <i class="fas fa-plus me-2"></i> Создать задачу
                                    {% endif %}
                                </button>

                                <a href="{% url 'qa_app:task_list' %}" class="btn btn-outline-secondary btn-submit">
                                    <i class="fas fa-times me-2"></i> Отмена
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('description');

    // Функции для простого редактора
    window.formatText = function(command) {
        if (!textarea) return;

        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        let newText = '';

        switch(command) {
            case 'bold':
                newText = `<strong>${selectedText}</strong>`;
                break;
            case 'italic':
                newText = `<em>${selectedText}</em>`;
                break;
            case 'underline':
                newText = `<u>${selectedText}</u>`;
                break;
            case 'fontSize:small':
                newText = `<span style="font-size: 12px">${selectedText}</span>`;
                break;
            case 'fontSize:medium':
                newText = `<span style="font-size: 16px">${selectedText}</span>`;
                break;
            case 'fontSize:large':
                newText = `<span style="font-size: 20px">${selectedText}</span>`;
                break;
            case 'link':
                const url = prompt('Введите URL ссылки:', 'https://');
                if (url) {
                    newText = `<a href="${url}" target="_blank">${selectedText || url}</a>`;
                } else {
                    return;
                }
                break;
            default:
                return;
        }

        // Вставляем отформатированный текст
        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);

        // Возвращаем фокус на текстовое поле
        textarea.focus();
        // Устанавливаем курсор после вставленного текста
        textarea.selectionStart = start + newText.length;
        textarea.selectionEnd = start + newText.length;
    };

    window.insertList = function(type) {
        if (!textarea) return;

        const start = textarea.selectionStart;
        const listItem = prompt('Введите элемент списка:');
        if (!listItem) return;

        const listTag = type === 'ul' ? '<ul>' : '<ol>';
        const listHTML = `${listTag}<li>${listItem}</li></${type === 'ul' ? 'ul' : 'ol'}>`;

        textarea.value = textarea.value.substring(0, start) + listHTML + textarea.value.substring(start);
        textarea.focus();
        textarea.selectionStart = start + listHTML.length;
        textarea.selectionEnd = start + listHTML.length;
    };

    window.insertHeading = function() {
        if (!textarea) return;

        const start = textarea.selectionStart;
        const text = prompt('Введите текст заголовка:');
        if (!text) return;

        const level = prompt('Уровень заголовка (1-6):', '2');
        if (!level || level < 1 || level > 6) return;

        const heading = `<h${level}>${text}</h${level}>`;

        textarea.value = textarea.value.substring(0, start) + heading + textarea.value.substring(start);
        textarea.focus();
        textarea.selectionStart = start + heading.length;
        textarea.selectionEnd = start + heading.length;
    };

    // Валидация формы
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Проверяем поле description
            if (textarea && (!textarea.value || !textarea.value.trim())) {
                e.preventDefault();

                // Показываем ошибку
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-2';
                errorDiv.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>Поле "Описание / Инструкция" обязательно для заполнения';

                // Вставляем сообщение об ошибке
                const editorWrapper = document.querySelector('.editor-wrapper');
                if (editorWrapper) {
                    editorWrapper.parentNode.insertBefore(errorDiv, editorWrapper.nextSibling);
                }

                // Прокручиваем к ошибке
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                textarea.focus();
            }

            // Проверяем поле title
            const titleField = document.getElementById('id_title');
            if (titleField && (!titleField.value || !titleField.value.trim())) {
                e.preventDefault();

                if (!titleField.classList.contains('is-invalid')) {
                    titleField.classList.add('is-invalid');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-danger small mt-1';
                    errorDiv.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>Это поле обязательно для заполнения';
                    titleField.parentNode.insertBefore(errorDiv, titleField.nextSibling);
                }

                titleField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                titleField.focus();
            }
        });
    }

    // Автосохранение в localStorage (опционально)
    if (textarea) {
        // Загружаем сохраненный текст из localStorage
        const savedText = localStorage.getItem('task_description_draft');
        if (savedText && !textarea.value.trim()) {
            if (confirm('У вас есть черновик описания. Загрузить его?')) {
                textarea.value = savedText;
            }
        }

        // Сохраняем текст при изменении (с задержкой)
        let saveTimeout;
        textarea.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(function() {
                if (textarea.value.trim()) {
                    localStorage.setItem('task_description_draft', textarea.value);
                } else {
                    localStorage.removeItem('task_description_draft');
                }
            }, 1000);
        });

        // Очищаем сохраненный текст при успешной отправке
        form.addEventListener('submit', function() {
            localStorage.removeItem('task_description_draft');
        });
    }
});
</script>
{% endblock %}